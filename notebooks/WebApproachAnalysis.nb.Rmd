---
title: "web-approach-avoidance-analysis"
output: html_notebook
---

library(tidyverse)
library(ggplot2)
library(proto)
library(gsubfn)
library(readr)
library(anytime)



#1 Create a dataFrame that is readable and stripped-off of special characters

Here is the import of the csv file from Psiturk -- Add path to csv to be parsed at the end of this block..
```{r}
populateMainTable <- function(dataPath){

#Import trialdata.csv (downloaded via the psiturk shell)  -->Directory:  "~/Dropbox/BachLab/RA/TestData/trialdata.csv"
trialdata <- read_csv(dataPath, col_names = FALSE)


#delete commas between [] first before creating , separated list 
trialdata$X4 <- gsubfn("\\[(?:[^(\\[\\])]++|(?R))*\\]", ~ gsub(",", " ", m, fixed=TRUE), trialdata$X4, perl=TRUE, backref=0)


#create df that can be further prepared to extract timetables.. 
# remove all \\ , { }, [ ]

trialdata$X4 <- as.character(gsub('\\[','', trialdata$X4 ))
trialdata$X4 <- as.character(gsub('\\\\','', trialdata$X4 ))
trialdata$X4 <- as.character(gsub('\\]','', trialdata$X4 ))
trialdata$X4 <- as.character(gsub('\\{','', trialdata$X4 ))
trialdata$X4 <- as.character(gsub('\\}','', trialdata$X4 ))
trialdata$X4 <- as.character(gsub('"','', trialdata$X4 ))


# From intital trialdata.csv - extract list[a(1..z), b(1..z),c(1..o)...] format for every trial entry 
# commaSeparatedList[1] --> list entry a  , [2] = b   => output entry a
# commaSeparatedList[[1]][1] --> list entry a1 ,      => output value 1 of entry a

commaSeparatedList <- strsplit(trialdata$X4, ",")


#create a (Mother) dataframe with all trials separated -> For each trial type column values

# Extract timetable relevant trials: AAALevelOne --> in a new Data frame 
# go through all trials and add values iteratively to create a main datatable. 

trialDataMainTable <- data.frame(matrix(nrow = nrow(trialdata), ncol=17,byrow=TRUE))
colnames(trialDataMainTable) <- c("uniqueUserID","trialIndex", "unixTime","trialType", "viewPageIndex/Time",
                                      "response","threatParameter","tokenAppDisap"
                                        ,"playerTrack","nrWonTokens", "tokenWonTrack","robberActivTrack", "playerCaughtTrack","playerIsCaught",
                                        "caughtRobberTrack","playerCaughtRobber", "failedCatchAttempt")

#delete all NA entries
trialDataMainTable[is.na(trialDataMainTable)] <- ""

#logic to fill table
#idea to hardcode trial number since order of trials is for all the same (has to be adjusted if altered in the experiment)
# 93 trials per subject --> rather not just look for the 10 trial types and distribute onto data frame - first on trial level then on value. 

# case treatment for every trial-type [nstructions,survey-multi-choice,survey-multi-choiceOriginal,text,AAALevelOne
                            # AAALevelTwoB,AAALevelTwoA,similarity,survey-text]
  
  for(i in 1:nrow(trialdata)){
   
                trialDataMainTable$uniqueUserID[[i]] <-  trialdata[[1]][i]
                trialDataMainTable$trialIndex[[i]] <-  trialdata[[2]][i]
                trialDataMainTable$unixTime <- as.numeric(as.character( trialDataMainTable$unixTime))
                trialDataMainTable$unixTime[[i]] <-  trialdata[[3]][i]/1000
                trialDataMainTable$unixTime[[i]] <- anytime(trialDataMainTable$unixTime[[i]])}
                trialDataMainTable$unixTime <- anytime(trialDataMainTable$unixTime)
           
#helper variables
index <- 0

# adds trialtype to trialDataMainTable
 for(i in commaSeparatedList){    # i loops through trials c[a(),b(),c(),d()]
   
    index <- index +1
   
    for(j in i){                   # j loops through trial values c[a(1..z),b(1..z),c(1..z)]
      
        if (grepl("trial_type:",j) == TRUE){
         trialDataMainTable$trialType[[index]] <- j
        }
                    }}

# handles import to main datatable through trialtype

#helper variables
upperIndex <- 0
lowerIndex <- 0

# adds trialtype to main datatable
for(i in commaSeparatedList){    # i loops through trials c[a(),b(),c(),d()]
  
  lowerIndex <- 0
  upperIndex <- upperIndex +1
  
  
    if(grepl("instructions",trialDataMainTable[[4]][upperIndex]) == TRUE){
        
      for(j in i){                   # j loops through trial values c[a(1..z),b(1..z),c(1..z)]
        
        lowerIndex <- lowerIndex + 1
        
          if(lowerIndex == 3){
          
          trialDataMainTable$`viewPageIndex/Time`[[upperIndex]] <- j}
        }
    }
  

    else if(grepl("^ trial_type: survey-multi-choice$",trialDataMainTable[[4]][upperIndex])){
      
         
        trialDataMainTable$response[[upperIndex]] <- lapply(trialDataMainTable$response[[upperIndex]], function (x) x[!is.na(x)])
       
         
        for(j in i){                
        
          lowerIndex <- lowerIndex + 1
        
           if(lowerIndex == 3 || lowerIndex == 4){
          
   
                trialDataMainTable$response[[upperIndex]] <- append(trialDataMainTable$response[[upperIndex]],j)}
              }
      }

  
    else if(grepl("^ trial_type: survey-multi-choiceOriginal$",trialDataMainTable[[4]][upperIndex])){
      
       trialDataMainTable$response[[upperIndex]] <- lapply(trialDataMainTable$response[[upperIndex]], function (x) x[!is.na(x)])
      
        
      for(j in i){                
        
        lowerIndex <- lowerIndex + 1
        
        if(lowerIndex >= 3 && grepl("Q",j) == TRUE){
          
          
          trialDataMainTable$response[[upperIndex]] <- append(trialDataMainTable$response[[upperIndex]],j)}
          }
       
     }
  

    else if(grepl("^ trial_type: AAALevelOne$",trialDataMainTable[[4]][upperIndex]) || grepl("^ trial_type: AAALevelTwoA$",trialDataMainTable[[4]][upperIndex])){
     
      for(j in i){                
        
        lowerIndex <- lowerIndex + 1
        
      if(lowerIndex != 2 || 6 || 8 || 10){
        
          switch(lowerIndex,trialDataMainTable$nrWonTokens[[upperIndex]] <- j,"",trialDataMainTable$threatParameter[[upperIndex]] <- j, trialDataMainTable$tokenAppDisap[[upperIndex]] <- j,
                 trialDataMainTable$playerTrack[[upperIndex]] <- j,"","","", trialDataMainTable$playerCaughtTrack[[upperIndex]] <- j,"", trialDataMainTable$robberActivTrack[[upperIndex]] <- j,
                 trialDataMainTable$playerIsCaught[[upperIndex]] <- j, trialDataMainTable$tokenWonTrack[[upperIndex]] <- j)
                 }
        
              }
      
        }
  
    else if(grepl("^trial_type: AAALevelTwoB$",trialDataMainTable[[4]][upperIndex])){
      
          for(j in i){                
      
          lowerIndex <- lowerIndex + 1
      
      if(lowerIndex != 1 || 7 || 8 || 9 || 10 || 13){
        
        switch(lowerIndex,"", trialDataMainTable$caughtRobberTrack[[upperIndex]] <- j,trialDataMainTable$failedCatchAttempt[[upperIndex]] <- j, trialDataMainTable$threatParameter[[upperIndex]] <- j,
               trialDataMainTable$robberActivTrack[[upperIndex]] <- j, trialDataMainTable$playerTrack[[upperIndex]] <- j,"","","","", trialDataMainTable$playerCaughtRobber[[upperIndex]] <- j,
               trialDataMainTable$tokenAppDisap[[upperIndex]] <- j,"")
            }
          }
      }
  
  
     else if(grepl("similarity",trialDataMainTable[[4]][upperIndex])){
    
        trialDataMainTable$response[[upperIndex]] <- lapply(trialDataMainTable$response[[upperIndex]], function (x) x[!is.na(x)])
       
    
            for(j in i){                
      
                lowerIndex <- lowerIndex + 1
      
                if(lowerIndex == 3){
        
                  trialDataMainTable$threatParameter[[upperIndex]] <- j}
                
            
              else if(lowerIndex == 8){
                
                  trialDataMainTable$response[[upperIndex]] <- append(trialDataMainTable$response[[upperIndex]],j)
                }
             }
            }
        }

      #roughly strip off redunant information in single slots
        trialDataMainTable$trialType <- as.character(gsub("(^ |trial_type: )", "", trialDataMainTable$trialType))
        trialDataMainTable$`viewPageIndex/Time` <- as.character(gsub("(^ |view_history: )", "", trialDataMainTable$`viewPageIndex/Time`))
        trialDataMainTable$threatParameter <- as.character(gsub("(^ |robberTrackColLamDict: )", "", trialDataMainTable$threatParameter))                 
        trialDataMainTable$tokenAppDisap <- as.character(gsub("(^ |tokkenTrackDict: )", "", trialDataMainTable$tokenAppDisap))
        trialDataMainTable$playerTrack <- as.character(gsub("(^ |playerTrackDict: )", "", trialDataMainTable$playerTrack))
        trialDataMainTable$nrWonTokens <- as.character(gsub("(^ |wonTokkens: )", "", trialDataMainTable$nrWonTokens))
        trialDataMainTable$tokenWonTrack <- as.character(gsub("(^ |tokkeWonTrackDict: )", "", trialDataMainTable$tokenWonTrack))
        trialDataMainTable$robberActivTrack <- as.character(gsub("(^ |robberTrackArr: )", "", trialDataMainTable$robberActivTrack))
        trialDataMainTable$playerCaughtTrack <- as.character(gsub("(^ |playerCaughtTrackDict: )", "", trialDataMainTable$playerCaughtTrack))
        trialDataMainTable$playerIsCaught <- as.character(gsub("(^ |playerIsCaught: )", "", trialDataMainTable$playerIsCaught))
        trialDataMainTable$caughtRobberTrack <- as.character(gsub("(^ |caughtRobberDict: )", "", trialDataMainTable$caughtRobberTrack))
        trialDataMainTable$playerCaughtRobber <- as.character(gsub("(^ |playerCaughtRobber: )", "", trialDataMainTable$playerCaughtRobber))
        trialDataMainTable$failedCatchAttempt <- as.character(gsub("(^ |failedCatchAttemptDict: )", "", trialDataMainTable$failedCatchAttempt))
 
   
             
  return(trialDataMainTable)
}
mainTable <- populateMainTable("~/Dropbox/BachLab/RA/TestData/completePilotRun21Sub.csv");
```

#2 Creates a dataFrame of all Participants with relevant data, here: LevelOneA &LevelTwoA

(for the calculation of a timetable --> and producing the graphs "approach/return latencies")

```{r}
timeTableInputData <- function(mainTable){

#Selecting only Trial/Level One and A (relevant for graph)
timeTableSelection <- mainTable[grepl("^(AAALevelOne|AAALevelTwoA)$",mainTable$trialType), ]

mySelection <- c("uniqueUserID","trialType","threatParameter","tokenAppDisap", "playerTrack", "tokenWonTrack", "playerCaughtTrack", "playerIsCaught")

#timeTableSelection relevant variables
timeTableSelection <- timeTableSelection[mySelection]


#for graph only threat level is important
timeTableSelection$threatParameter <- as.character(gsub("color:yellow parameter:&#955; = ",'', timeTableSelection$threatParameter))
timeTableSelection$threatParameter <- as.character(gsub("color:azure parameter:&#955; = ",'', timeTableSelection$threatParameter))
timeTableSelection$threatParameter <- as.character(gsub("color:purple parameter:&#955; = ",'', timeTableSelection$threatParameter))


# Convert all to lists of characters 
timeTableSelection$tokenAppDisap <- as.character(gsub("position:",'', timeTableSelection$tokenAppDisap))
timeTableSelection$tokenAppDisap <- as.character(gsub("time:",'', timeTableSelection$tokenAppDisap))
timeTableSelection$tokenAppDisap <- as.character(gsub(" ",',', timeTableSelection$tokenAppDisap))
timeTableSelection$tokenAppDisap <- strsplit(timeTableSelection$tokenAppDisap, ",")

timeTableSelection$playerTrack <- as.character(gsub("position:",'', timeTableSelection$playerTrack))
timeTableSelection$playerTrack <- as.character(gsub("time:",'', timeTableSelection$playerTrack))
timeTableSelection$playerTrack <- as.character(gsub(" ",',', timeTableSelection$playerTrack))
timeTableSelection$playerTrack <- strsplit(timeTableSelection$playerTrack , ",")

timeTableSelection$tokenWonTrack <- as.character(gsub("position:",'', timeTableSelection$tokenWonTrack))
timeTableSelection$tokenWonTrack <- as.character(gsub("time:",'', timeTableSelection$tokenWonTrack))
timeTableSelection$tokenWonTrack <- as.character(gsub(" ",',', timeTableSelection$tokenWonTrack))
timeTableSelection$tokenWonTrack <- strsplit(timeTableSelection$tokenWonTrack , ",")

timeTableSelection$playerCaughtTrack <- as.character(gsub("position:",'', timeTableSelection$playerCaughtTrack))
timeTableSelection$playerCaughtTrack <- as.character(gsub("time:",'', timeTableSelection$playerCaughtTrack))
timeTableSelection$playerCaughtTrack <- as.character(gsub(" ",',', timeTableSelection$playerCaughtTrack))
timeTableSelection$playerCaughtTrack <- strsplit(timeTableSelection$playerCaughtTrack , ",")

#Convert all to lists of integers
timeTableSelection$tokenAppDisap <- lapply(timeTableSelection$tokenAppDisap, as.integer)
timeTableSelection$playerTrack   <- lapply(timeTableSelection$playerTrack, as.integer)
timeTableSelection$tokenWonTrack <- lapply(timeTableSelection$tokenWonTrack, as.integer)
timeTableSelection$playerCaughtTrack <- lapply(timeTableSelection$playerCaughtTrack, as.integer)

return(timeTableSelection)
}
relevantTrialLvls <- timeTableInputData(mainTable)
```

#3 creating timetable and graphs (approach/return latencies) averages over all participants in the database
```{r}
drawChart <- function(preparedDataFrame){  #Input: dataFrame (received through timeTableInputData), chosen Participant String ID Output: List of graphs for chosen participant --> averages over all for now9

  
onlyCaughtFalse <- preparedDataFrame[which(preparedDataFrame$playerIsCaught == "false"),]
#First match dataFrame for chosen uniqueUserID  
timeTable <- onlyCaughtFalse
# only analyse trials where player wasnt caught

#timeTable <- onlyCaughtFalse[grepl(uniqueUserID,onlyCaughtFalse$uniqueUserID), ] # for a specific participant 

#timeTable <- onlyCaughtFalse[grepl("A9692Y27LBXT9:3DYGAII7PM6SSO6CV6KEOH2ITWEPQL", onlyCaughtFalse$uniqueUserID), ]
#create timeline, Object, Location, Time, Event 

TimeLine <- matrix(nrow =0, ncol=6,byrow=TRUE)
colnames(TimeLine) <- c("TrialNr","Object", "Location", "Time", "Event","Threat")

index <- TRUE
location <- "Na"
timing <- "Na"
count <- 0
trialNr <- 0
oldTrial <- 1


for(i in timeTable$tokenAppDisap){    #for every column a new for-loop
  
  count <- count + 1
  trialNr <- trialNr +1
  
  if(oldTrial != trialNr){
    index <- TRUE}
  
    for(j in i){
      
      if(j == -1){
        location <- -1}
      
      else if (j == 1){
        location <- 1}
      
      if(index == TRUE){
        event <- "appeared"}
      
      else if (index == FALSE) {
        event <- "disappeared"}
      
      if(j > 1){
        oldTrial <- trialNr
        timing <- j
        threat <- as.double(timeTable$threatParameter[count])
        TimeLine <- rbind(TimeLine, c(trialNr,"Token",location,timing,event,threat))
        
        if (index == TRUE){
          index <-  FALSE}
        
        else {
          index <- TRUE}
      }
    }
}

count <- 0
trialNr <- 0

for(i in timeTable$playerTrack){
  
  count <- count + 1
  trialNr <- trialNr +1
  
  for(j in i){                     
    
    if(j == -1){
      location <- -1
      event <- "approach"}
    
    else if (j == 1){
      location <- 1
      event <- "approach"}
    
    else if (j == 0){
      location <- 0
      event <- "return"}
    
    if(j > 1){
      timing <- j
      threat <- as.double(timeTable$threatParameter[count])
      TimeLine <- rbind(TimeLine, c(trialNr,"Player",location,timing,event,threat))
      
    }
  }
}

count <- 0
trialNr <- 0


for(i in  timeTable$tokenWonTrack){
  
  count <- count + 1
  trialNr <- trialNr +1
  
  for(j in i){                     
    
    if(j == -1){
      location <- -1}
    
    else if (j == 1){
      location <- 1}
    
    if(j > 1){
      timing <- j
      threat <- as.double(timeTable$threatParameter[count])
      TimeLine <- rbind(TimeLine, c(trialNr,"Token",location,timing,"won",threat))
    }
  }
}

count <- 0
trialNr <- 0


#Convert TimeLine to a dataFrame
TimeLine <- data.frame(TimeLine)
TimeLine$Time <- as.numeric(as.character(TimeLine$Time))
TimeLine$TrialNr <- as.numeric(as.character(TimeLine$TrialNr))
#Order time and trialNr chronologically 
TimeLine <- TimeLine[order(TimeLine$Time),]
TimeLine <- TimeLine[order(TimeLine$TrialNr),]


# plot data from TimeLine --> Transform and analyse first in a new data frame

# for loop orients on trialNr -- approach and return do on nr of token - token appear and disappear

#Continue with TimeLine

#UniqueUserID, Tria(nr),TokenNr(1-6), TokenAlreadyWon(0-5) or PotentialLoss, ApproachLatency(time),ReturnLatency(time) + Threat
plotTable <- matrix(nrow =0, ncol=7,byrow=TRUE)
colnames(plotTable) <- c("Trial", "TokenNr", "TokenAlreadyWon","Approached","ApproachLatency", "ReturnLatency","Threat")

#data goes by tokkens, first to know how many tokkens appreared and won per trial
#Plot
Trial <- 1
TokenNr <- 1
Approached <- 0
tokensAlreadyWon <- 0
ApproachLatency <- 0
ReturnLatency <- 0
Threat <- as.numeric(as.character(TimeLine$Threat[1]))

#Helper
TokenHasAppeared <- FALSE
tokenWon <- FALSE
timeOfApproach <- 0
timeOfReturn <- 0
timeOfAppearance <- 0
timeOfWon <- 0
tokenCount <- 1


for(i in 1:nrow(TimeLine)){
  

  if(TimeLine$Event[i] == "appeared"){
    
    
    if(tokenCount == 7){  #update trial, threat and alreadyWon
      
      Trial <-  TimeLine$TrialNr[i+1]
      Threat <- as.numeric(as.character(TimeLine$Threat[i]))
      tokensAlreadyWon <- 0
      tokenCount <- 1
      TokenNr <- 1
    }
    
       if(TokenHasAppeared == TRUE){
      
        
            #bind information of last token cycle and reset it for the new one. 
              plotTable <-  rbind(plotTable, c(Trial,TokenNr,tokensAlreadyWon,Approached, ApproachLatency,ReturnLatency,Threat))
         
              tokenCount <- tokenCount + 1
              TokenNr <- TokenNr + 1
        
            #reset
              Approached <- 0
              ApproachLatency <- 0
              ReturnLatency <- 0
              playerReturn <- FALSE
        
         
                if(tokenWon == TRUE){
           
                    tokensAlreadyWon <- tokensAlreadyWon + 1
                    tokenWon <- FALSE}
              }
    
    #bind information of current token cycle  plotTable <- rbind(plotTable, c(UniqueUserID,Trial,TokenNr,tokensAlreadyWon,Approached, ApproachLatency,ReturnLatency,Threat))
    
        TokenHasAppeared <- TRUE
        timeOfAppearance <- TimeLine$Time[i]
        }
  
  
   else if(TimeLine$Event[i] == "approach"){  # ---> If approach with appear == false = late reaction > if in range of interval bind in plottable[i-1]
    
      Approached <- 1
    
      #Approach latency calc here
      timeOfApproach <- TimeLine$Time[i]
      ApproachLatency <- timeOfApproach - timeOfAppearance
    
        if(ApproachLatency <= 150 || ApproachLatency >= 2000){
      
            ApproachLatency <- "out of bound"}
    
              }
  
   else if(TimeLine$Event[i] == "won"){
    
      timeOfWon <- TimeLine$Time[i]
      tokenWon <- TRUE}
  
  
   else if(TimeLine$Event[i] == "return"){
    
      #Return latency calc here
      timeOfReturn <- TimeLine$Time[i]
      ReturnLatency <- timeOfReturn - timeOfApproach
    
        if(ReturnLatency <= 0 || ReturnLatency >= 2000){
      
                ReturnLatency <- "out of bound"}
  }
}

# bind the last token cycle which lies outside of the timeLine loop
plotTable <-  rbind(plotTable, c(Trial,TokenNr,tokensAlreadyWon,Approached, ApproachLatency,ReturnLatency,Threat))


#Convert to Dataframe
plotTable <- data.frame(plotTable)
plotTableNoOutofBound <- plotTable[which(plotTable$ApproachLatency != "out of bound"),]
plotTableNoOutofBound <- plotTableNoOutofBound[which(plotTableNoOutofBound$ReturnLatency != "out of bound"),]
#------- Create Line Charts
  
# convert factor to numeric for convenience 
plotTableNoOutofBound$TokenAlreadyWon <- as.numeric(as.character(plotTableNoOutofBound$TokenAlreadyWon))
plotTableNoOutofBound$ApproachLatency <- as.numeric(as.character(plotTableNoOutofBound$ApproachLatency))
plotTableNoOutofBound$ReturnLatency <- as.numeric(as.character(plotTableNoOutofBound$ReturnLatency))
plotTableNoOutofBound$Threat <- as.numeric(as.character(plotTableNoOutofBound$Threat))
plotTableNoOutofBound$Approached <- as.numeric(as.character(plotTableNoOutofBound$Approached))

ApproachedTrue <- plotTableNoOutofBound[which(plotTableNoOutofBound$Approached == 1),]
ReturnedTrue <- plotTableNoOutofBound[which(plotTableNoOutofBound$Approached == 1),]

#create Table with average approach/return latencies for every nr of token

ApproachPlot <- aggregate(ApproachedTrue$ApproachLatency, by = list(Threat = ApproachedTrue$Threat, tokensAlreadyWon = ApproachedTrue$TokenAlreadyWon), FUN=mean)

ReturnPlot <- aggregate(ReturnedTrue$ReturnLatency, by = list(Threat = ReturnedTrue$Threat, tokensAlreadyWon = ReturnedTrue$TokenAlreadyWon), FUN=mean)

#create proportion approach
nrOfTrials1 <- length(which(grepl(1.0536, plotTableNoOutofBound$Threat)))/6
nrOfTrials2 <- length(which(grepl(2.2314, plotTableNoOutofBound$Threat)))/6
nrOfTrials3 <- length(which(grepl(3.5667, plotTableNoOutofBound$Threat)))/6
  
count2 <- function(x) c(sum(x == 0, sum(x == 1)))
SumActionPlot <- aggregate(plotTableNoOutofBound$Threat, by = list(Trial = plotTableNoOutofBound$Trial, Threat = plotTableNoOutofBound$Threat, tokensAlreadyWon = plotTableNoOutofBound$TokenAlreadyWon, Approached = plotTableNoOutofBound$Approached), FUN= count2)
SumActionPlot <- SumActionPlot[order(SumActionPlot$Trial),]


ActionPlot <- matrix(nrow = 0, ncol=3,byrow=TRUE)
colnames(ActionPlot) <- c("Threat", "tokensAlreadyWon","x")


#helper variables
alreadyWon1 <- 0
alreadyWon2 <- 0
alreadyWon3 <- 0
trialNr <- as.integer(SumActionPlot$Trial[[1]])

lossMapping1 <- list("0"= 0,"1"= 0,"2"= 0,"3"= 0,"4" = 0,"5"= 0,"6"= 0)
lossMapping2 <- list("0"= 0,"1"= 0,"2"= 0,"3"= 0,"4" = 0,"5"= 0,"6"= 0)
lossMapping3 <- list("0"= 0,"1"= 0,"2"= 0,"3"= 0,"4" = 0,"5"= 0,"6"= 0)


for(i in 1:nrow(SumActionPlot)){
  
  if(as.integer(SumActionPlot$Trial[i]) != trialNr){
    
    trialNr <- as.integer(SumActionPlot$Trial[[i]])
    alreadyWon1 <- 0
    alreadyWon2 <- 0
    alreadyWon3 <- 0
  }
  
  if(SumActionPlot$Threat[i] == 1.0536){
      
        if(SumActionPlot$Approached[i] == 1 && SumActionPlot$tokensAlreadyWon[i] == alreadyWon1){
          
            alreadyWon1 <- alreadyWon1 + 1
            lossMapping1[[alreadyWon1]] <- lossMapping1[[alreadyWon1]] + 1
           
        }
  }
  
  else if(SumActionPlot$Threat[i] == 2.2314){
    
    if(SumActionPlot$Approached[i] == 1 && SumActionPlot$tokensAlreadyWon[i] == alreadyWon2){
      
      alreadyWon2 <- alreadyWon2 + 1
      lossMapping2[[alreadyWon2]] <- lossMapping2[[alreadyWon2]] + 1
    }
 }
  
  else if(SumActionPlot$Threat[i] == 3.5667){
    
    if(SumActionPlot$Approached[i] == 1 && SumActionPlot$tokensAlreadyWon[i] == alreadyWon3){
      
      alreadyWon3 <- alreadyWon3 + 1
      lossMapping3[[alreadyWon3]] <- lossMapping3[[alreadyWon3]] + 1
    }
  }

}

index1 <- 1
while(index1<=length(lossMapping1)){

  ActionPlot <-  rbind(ActionPlot, c(1.0536, index1 -1 ,lossMapping1[[index1]]/nrOfTrials1))
  index1 <- index1 + 1
}

index2 <- 1
while(index2<=length(lossMapping2)){
  
  ActionPlot <-  rbind(ActionPlot, c(2.2314, index2 -1 ,lossMapping2[[index2]]/nrOfTrials2))
  index2 <- index2 + 1
}

index3 <- 1
while(index3<=length(lossMapping3)){
  
  ActionPlot <-  rbind(ActionPlot, c(3.5667, index3 -1 ,lossMapping3[[index3]]/nrOfTrials3))
  index3 <- index3 + 1
}

ActionPlot <- data.frame(ActionPlot)




#approach latencies
Approach <-  ggplot(ApproachPlot, aes(ApproachPlot$tokensAlreadyWon, ApproachPlot$x , group=factor(ApproachPlot$Threat))) +
  geom_line(aes(color=factor(ApproachPlot$Threat))) + theme_bw() +
  labs(title = "Approach" , x = "Potential loss (tokens)", y = "Approach latency (ms)", color = "Threat level")

#return latencies
Return <-  ggplot(ReturnPlot, aes(ReturnPlot$tokensAlreadyWon, ReturnPlot$x, group=factor(ReturnPlot$Threat))) +
  geom_line(aes(color=factor(ReturnPlot$Threat))) + theme_bw() + 
  labs(title = "Return" , x = "Potential loss (tokens)", y = "Return latency (ms)", color = "Threat level")

#Action
Action <- ggplot(ActionPlot, aes(ActionPlot$tokensAlreadyWon, ActionPlot$x, group=factor(ActionPlot$Threat))) +
  geom_line(aes(color=factor(ActionPlot$Threat))) + theme_bw() + 
  labs(title = "Action" , x = "Potential loss (tokens)", y = "Proportion Approach", color = "Threat level")

  return(list(Approach,Return,Action))

}

averagePlot <- drawChart(relevantTrialLvls)

show(averagePlot)
```
#4 evaluation of the questionnaire battery
```{r}
#extraction and evaluation of all questionnaires in a new dataFrame
evaluateQuestionnaires <- function(mainTable){

#Output table
questionnairesEvaluation <- data.frame(matrix(nrow = length(unique(mainTable[["uniqueUserID"]])), ncol=14,byrow=TRUE))
colnames(questionnairesEvaluation) <- c("uniqueUserID","IQ", "bis", "ocir", "schizo","zungdep","lebsocial","alcoholadd",
                                          "apathy","eat","anxiety1State","anxiety2Trait","anxietyTMAS","daringnessCADS")

#helper table
questionnaireData <- data.frame(matrix(nrow = 200, ncol=14,byrow=TRUE))

mySelection <- c("uniqueUserID","trialType","trialIndex","unixTime","response")

allQuestionnaireData <- mainTable[grepl("^(survey-multi-choiceOriginal)$",mainTable$trialType), ]

allQuestionnaireData <- allQuestionnaireData[mySelection]

#helper variables --> just for one test now, indexing through different participants must be solved differently to able to evaluate all questionnaire scores
participantId <- allQuestionnaireData$uniqueUserID[1]
nrOfParticipant <- 1

for(i in 1:nrow(allQuestionnaireData)){
  
  if(allQuestionnaireData$response[[i]][1] == ""){

    allQuestionnaireData$response[[i]][1] <- NULL
  }}
 
for(i in 1:nrow(allQuestionnaireData)){
    allQuestionnaireData$response[[i]][1] <- as.character(gsub(" responses: ",'', allQuestionnaireData$response[[i]][1]))
  }


# loop through all questionnaire answers from all participants
for(i in 1:nrow(allQuestionnaireData)){
  
  if(participantId != allQuestionnaireData$uniqueUserID[i]){
    
    nrOfParticipant <- nrOfParticipant + 1
    participantId <- allQuestionnaireData$uniqueUserID[i]
  }

  #searching for IQ- Test in questionnaire battery for one participant 
  if(grepl("It's",allQuestionnaireData$response[[i]][2]) | grepl("Richard",allQuestionnaireData$response[[i]][2])){
    
    participantScore <- 0
    #-- Scoring Iq-test = sum of right answers [4 4 4 6 6 3 4 4 5 2 2 4 3 2 6 7]
    for(j in allQuestionnaireData$response[[i]]){
      
        if(j == "Q0:5"){ participantScore <- participantScore + 1}
        else if(j == "Q1:It's impossible to tell"){ participantScore <- participantScore + 1 }
        else if(j == "Q2:47"){ participantScore <- participantScore + 1 }
        else if(j == "Q3:Sunday"){ participantScore <- participantScore + 1 }
        else if(j == "Q4:X"){ participantScore <- participantScore + 1 } 
        else if(j == "Q5:G"){ participantScore <- participantScore + 1 }
        else if(j == "Q6:X"){ participantScore <- participantScore + 1 }
        else if(j == "Q7:N"){ participantScore <- participantScore + 1 }
        else if(j == "Q8:E"){ participantScore <- participantScore + 1 }
        else if(j == "Q9:B"){ participantScore <- participantScore + 1 }
        else if(j == "Q10:B"){ participantScore <- participantScore + 1 }
        else if(j == "Q11:D"){ participantScore <- participantScore + 1 }
        else if(j == "Q12:C"){ participantScore <- participantScore + 1 }
        else if(j == "Q13:B"){ participantScore <- participantScore + 1 }
        else if(j == "Q14:F"){ participantScore <- participantScore + 1 }
        else if(j == "Q15:G"){ participantScore <- participantScore + 1 }
    }
    
          #plot iq value for participant here. 
        questionnairesEvaluation$uniqueUserID[nrOfParticipant] <- allQuestionnaireData$uniqueUserID[[i]]
        questionnairesEvaluation$IQ[nrOfParticipant] <- participantScore
    }
  
  #searching for Zung- Test in questionnaire battery for one participant 
  if(grepl(" of the time",allQuestionnaireData$response[[i]][2])){
    
    participantScore <- 0
    qIndex <- -1
    #-- Scoring Zung-test = value of 1, 2, 3 and 4 is assigned to a response 
    for(j in allQuestionnaireData$response[[i]]){
      
      qIndex <- qIndex + 1

      #normal scoring Items 1, 3, 4, 7, 8, 9, 10, 13, 15, 19 
      if(qIndex %in% c(0,2,3,6,7,8,9,12,14,18)){
      if(grepl("A little of the time",j)){participantScore <- participantScore + 1}
      if(grepl("Some of the time",j)){participantScore <- participantScore + 2}
      if(grepl("Good part of the time",j)){participantScore <- participantScore + 3}
      if(grepl("Most of the time",j)){participantScore <- participantScore + 4}
      }
      #reversed Items 2, 5, 6, 11, 12, 14, 16, 17, 18, 20 
      if(qIndex %in% c(1,4,5,10,11,13,15,16,17,19)){
      if(grepl("A little of the time",j)){participantScore <- participantScore + 4}
      if(grepl("Some of the time",j)){participantScore <- participantScore + 3}
      if(grepl("Good part of the time",j)){participantScore <- participantScore + 2}
      if(grepl("Most of the time",j)){participantScore <- participantScore + 1}
      }
      #plot zungDep value for participant here.  The SDS index is derived by dividing the sum of the values (raw scores) obtained on the 20 items by the maximum possible score of 80
      questionnairesEvaluation$uniqueUserID[nrOfParticipant] <- allQuestionnaireData$uniqueUserID[[i]]
      questionnairesEvaluation$zungdep[nrOfParticipant] <- round(participantScore/80,digits=2)
    }
    
  }
  
  #searching for Ocir- Test in questionnaire battery for one participant   
  if(grepl("^Extremely|A little|A lot|Moderately|Not at all$",allQuestionnaireData$response[[i]][2]) && length(allQuestionnaireData$response[[i]]) == 18){
    
    participantScore <- 0
    #-- Scoring Ocir-test = each item is scored on a 5-point scale (0-4 points), and the total score is the sum of the scores on all items. 
    for(j in allQuestionnaireData$response[[i]]){
      
      if(grepl("Not at all",j)){participantScore <- participantScore + 0}
      if(grepl("A little",j)){participantScore <- participantScore + 1}
      if(grepl("Moderately",j)){participantScore <- participantScore + 2}
      if(grepl("A lot",j)){participantScore <- participantScore + 3}
      if(grepl("Extremely",j)){participantScore <- participantScore + 4}
    }
    
    #plot ocir value for participant here. The possible range of scores is from 0-72 --> mean score for persons with OCD is 28.0 (Foa, E.B., Huppert, J.D., Leiberg, S., Hajcak, G., Langner, R., et al. (2002).)
    questionnairesEvaluation$uniqueUserID[nrOfParticipant] <- allQuestionnaireData$uniqueUserID[[i]]
    questionnairesEvaluation$ocir[nrOfParticipant] <- participantScore
  }
  
  #searching for BIS11- Test in questionnaire battery for one participant
  if(grepl("Do not agree at all|Agree slightly|Agree a lot|Agree completely",allQuestionnaireData$response[[i]][2])){
    
    participantScore <- 0
    #1st order factors
    bisAttention <- 0
    bisCognitiveInstability <- 0
    bisMotor <- 0
    bisPerseverance <- 0
    bisSelfControl <- 0
    bisCognitiveComplexity <- 0
    
    #2nd order factors
    bisAttentional <- 0
    bisMotor2ndfactor <- 0
    bisNonplanning <-0
    # total score (sum of 2nd order factors)
    bisScore <- 0
    
    qIndex <- -1
    
    #-- Scoring BIS-test = value of 1, 2, 3 and 4 is assigned to a response 
    for(j in allQuestionnaireData$response[[i]]){
      
      qIndex <- qIndex + 1
      
      #normal scoring Items 2, 3, 4, 5, 6, 11, 14, 16, 21, 23, 17, 18, 19, 22, 24, 25, 26, 27, 28
      if(qIndex %in% c(1,2,3,4,5,10,13,15,20,22,16,17,18,21,23,24,25,26,27)){
        if(grepl("Do not agree at all",j)){participantScore <- participantScore + 1}
        if(grepl("Agree slightly",j)){participantScore <- participantScore + 2}
        if(grepl("Agree a lot",j)){participantScore <- participantScore + 3}
        if(grepl("Agree completely",j)){participantScore <- participantScore + 4}
        
         #1st order normal
          if(qIndex %in% c(4,10,27)){ bisAttention <-  bisAttention + participantScore}
          if(qIndex %in% c(5,23,25)){ bisCognitiveInstability <- bisCognitiveInstability + participantScore}
          if(qIndex %in% c(1,2,3,16,17,21,24)){ bisMotor <- bisMotor + participantScore}
          if(qIndex %in% c(15,20,22)){ bisPerseverance <- bisPerseverance + participantScore} 
          if(qIndex == 13){ bisSelfControl <- bisSelfControl + participantScore}
          if(qIndex %in% c(17,26)){ bisCognitiveComplexity <- bisCognitiveComplexity + participantScore}
          
          participantScore <- 0
      }
      
      #reversed Items 1, 7, 8, 9, 10, 12, 13, 15, 20, 29, 30
      if(qIndex %in% c(0,6,7,8,9,11,12,14,19,28,29)){
        if(grepl("Do not agree at all",j)){participantScore <- participantScore + 4}
        if(grepl("Agree slightly",j)){participantScore <- participantScore + 3}
        if(grepl("Agree a lot",j)){participantScore <- participantScore + 2}
        if(grepl("Agree completely",j)){participantScore <- participantScore + 1}
          
          #1st order reversed
          if(qIndex %in% c(8,19)){ bisAttention <- bisAttention + participantScore}
          if(qIndex == 29){ bisPerseverance <- bisPerseverance + participantScore} 
          if(qIndex %in% c(0,6,7,11,12)){ bisSelfControl <- bisSelfControl + participantScore}
          if(qIndex %in% c(9,14,28)){ bisCognitiveComplexity <- bisCognitiveComplexity + participantScore}
          
          participantScore <- 0
            }
        }
        #calculation 2nd order Factors + total score (sum 1st order factors)
        bisAttentional <- bisAttention + bisCognitiveInstability 
        bisMotor2ndfactor <- bisMotor + bisPerseverance
        bisNonplanning <- bisSelfControl + bisCognitiveComplexity
        
        bisScore <- bisAttentional + bisMotor2ndfactor + bisNonplanning

        questionnairesEvaluation$uniqueUserID[nrOfParticipant] <- allQuestionnaireData$uniqueUserID[[i]]
        questionnairesEvaluation$bis[nrOfParticipant] <- bisScore
      }
  
  #searching for Schizo- Test in questionnaire battery for one participant
  if(grepl("^Q1:Yes$|^Q1:No$",allQuestionnaireData$response[[i]][2])){
  
    participantScore <- 0
    #1st order factors
    unusual_experiences <- 0
    cognitive_disorganisation <- 0
    introvertive_anhedonia <- 0
    impulsive_nonconformity <- 0
   
    #2nd order factor
    schizoScore <- 0
    
    qIndex <- -1
    
    #-- Scoring Schizo-test = value of 1, 0 is assigned to yes or no
    for(j in allQuestionnaireData$response[[i]]){
      
      qIndex <- qIndex + 1
    
      #normal scoring Items 1-25, 29, 32-33, 35, 36, 38, 40-43
      if(qIndex %in% c(0:11,13:25,29,33,34,36,37,39,41:44)){
        if(grepl("Yes",j)){participantScore <- participantScore + 1}
        if(grepl("No",j)){participantScore <- participantScore + 0}
      
        #1st order normal
        if(qIndex %in% c(0:11)){  unusual_experiences <-   unusual_experiences + participantScore}
        if(qIndex %in% c(13:23)){ bisCognitiveInstability <- bisCognitiveInstability + participantScore}
        if(qIndex %in% c(24:29,31:34)){ introvertive_anhedonia <- introvertive_anhedonia + participantScore}
        if(qIndex %in% c(35:44)){ impulsive_nonconformity <-  impulsive_nonconformity + participantScore}
      
        participantScore <- 0
      }
      
      #reversed Items 26 27 28 30 31 34 37 39
      if(qIndex %in% c(26,27,28,31,32,35,38,40)){
        if(grepl("Yes",j)){participantScore <- participantScore + 0}
        if(grepl("No",j)){participantScore <- participantScore + 1}
        
        #1st order reversed
        if(qIndex %in% c(26:28,31,32)){ introvertive_anhedonia <- introvertive_anhedonia + participantScore}
        if(qIndex %in% c(35:40)){ impulsive_nonconformity <-  impulsive_nonconformity + participantScore}
        
        participantScore <- 0
      }
    }
    #calculation 2n order total score (sum 1nd order factors)
    schizoScore <- unusual_experiences + bisCognitiveInstability + introvertive_anhedonia + impulsive_nonconformity
    
    questionnairesEvaluation$uniqueUserID[nrOfParticipant] <- allQuestionnaireData$uniqueUserID[[i]]
    questionnairesEvaluation$schizo[nrOfParticipant] <- schizoScore
  }
  
  #searching for LebSocial- Test in questionnaire battery for one participant
  if(length(allQuestionnaireData$response[[i]]) == 48){
    
    #1st order factors
    fearScore <- 0
    avoidanceScore <- 0
  
    #2nd order factor
    lebSocialScore <- 0
    
    qIndex <- -1
    
    
    #-- Scoring Leb-Social all even items score on fear all odd items to avoidance with 0-3
    for(j in allQuestionnaireData$response[[i]]){
      
      qIndex <- qIndex + 1
      
      #1st normal scoring even Items 0 - 48 - fear
      if(qIndex %% 2 == 0){
        if(grepl("None",j)){fearScore <- fearScore + 0}
        if(grepl("Mild",j)){fearScore <- fearScore + 1}
        if(grepl("Moderate",j)){fearScore <- fearScore + 2}
        if(grepl("Severe",j)){fearScore <- fearScore + 3}
      }
      
      #1st normal scoring odd Items 0 - 48 - avoidance
      if(qIndex %% 2 == 1){
        if(grepl("Never (0%)",j)){avoidanceScore <- avoidanceScore + 0}
        if(grepl("Occasionally (1&#8212;33%)",j)){avoidanceScore <- avoidanceScore + 1}
        if(grepl("Often (33&#8212;67%)",j)){avoidanceScore <- avoidanceScore + 2}
        if(grepl("Usually (67&#8212;100%)",j)){avoidanceScore <- avoidanceScore + 3}
        
      }
      
      #calculation 2nd order Factors + total score (sum 1st order factors)
      lebSocialScore <- fearScore + avoidanceScore
      
      questionnairesEvaluation$uniqueUserID[nrOfParticipant] <- allQuestionnaireData$uniqueUserID[[i]]
      questionnairesEvaluation$lebsocial[nrOfParticipant] <- lebSocialScore
    }
  }
  
  #searching for Alcohol- Test in questionnaire battery for one participant
  if(grepl("1 or 2|3 or 4|5 or 6|7 to 9|10 or more",allQuestionnaireData$response[[i]][2])){
    
    participantScore <- 0
    
    #1st order factors
    consumptionScore <- 0 
    dependenceScore <- 0
    alcoholRelated <- 0
    
    #2nd order factors
    alcoholScore <- 0
    
    qIndex <- -1
    
    #-- Scoring Alcohol-test = value of 0-4 for  Q:1-8 and 0,2,4 for Q:9-10
    for(j in allQuestionnaireData$response[[i]]){
      
      qIndex <- qIndex + 1
      
      if(grepl("Never|1 or 2",j)){participantScore <- participantScore + 0}
      if(grepl("Monthly or less|3 or 4|Less than monthly",j)){participantScore <- participantScore + 1}
      if(grepl("Two to four times a month|5 or 6|Monthly",j)){participantScore <- participantScore + 2}
      if(grepl("Two to three times a week|7 to 9|Weekly",j)){participantScore <- participantScore + 3}
      if(grepl("Four or more times a week|10 or more|Daily or almost daily",j)){participantScore <- participantScore + 4}
      
      if(grepl("No",j)){participantScore <- participantScore + 0}
      if(grepl("Yes, but not in the last year",j)){participantScore <- participantScore + 2}
      if(grepl("Yes, during the last year",j)){participantScore <- participantScore + 4}
  
      # 1st order factor Consumption Score 
      if(qIndex %in% c(0:2)){
        consumptionScore <- consumptionScore + participantScore
      } 
      # 1st order factor Dependence Score 
      if(qIndex %in% c(3:5)){
        dependenceScore <-  dependenceScore + participantScore
      }
      # 1st order factor Alcohol-related problems Score
      if(qIndex %in% c(6:9)){
        alcoholRelated <- alcoholRelated + participantScore
      }
      participantScore <- 0
    }
    
      #calculation 2n order total score (sum 1nd order factors)
      alcoholScore <- consumptionScore + dependenceScore + alcoholRelated
    
      questionnairesEvaluation$uniqueUserID[nrOfParticipant] <- allQuestionnaireData$uniqueUserID[[i]]
      questionnairesEvaluation$alcoholadd[nrOfParticipant] <- alcoholScore

  }
   
  #searching for Apathy- Test in questionnaire battery for one participant
  if(grepl("Not at all characteristic|Slightly characteristic|Somewhat characteristic|Very characteristic",allQuestionnaireData$response[[i]][2])){
    
  
    #apathy is coded so higher number means higher apathy, so reverse score the entire thing except for qn 6, 10 and 11 //  cutoff scores of 39-41
    apathyScore <- 0
  
    qIndex <- -1
    
    #-- Scoring Apathy-test = value of 1-4 for
    for(j in allQuestionnaireData$response[[i]]){
      
      qIndex <- qIndex + 1
      
      #normal scoring Items 6, 10, 11
      if(qIndex %in% c(5,9,10)){
        if(grepl("Not at all characteristic",j)){apathyScore <- apathyScore + 1}
        if(grepl("Slightly characteristic",j)){apathyScore <- apathyScore + 2}
        if(grepl("Somewhat characteristic",j)){apathyScore <- apathyScore + 3}
        if(grepl("Very characteristic",j)){apathyScore <- apathyScore + 4}
      }
      
      #reversed scoring Items 1 2 3 4 5 7 8 9 12 13 14 15 16 17 18
      if(qIndex %in% c(0,1,2,3,4,6,7,8,11,12,13,14,16,17)){
        if(grepl("Not at all characteristic",j)){apathyScore <- apathyScore + 4}
        if(grepl("Slightly characteristic",j)){apathyScore <- apathyScore + 3}
        if(grepl("Somewhat characteristic",j)){apathyScore <- apathyScore + 2}
        if(grepl("Very characteristic",j)){apathyScore <- apathyScore + 1}
      }
      
    }
    questionnairesEvaluation$uniqueUserID[nrOfParticipant] <- allQuestionnaireData$uniqueUserID[[i]]
    questionnairesEvaluation$apathy[nrOfParticipant] <- apathyScore
    
  }

  #searching for Eat- Test in questionnaire battery for one participant
  if(grepl("Always|Usually|Often|Sometimes|Rarely|Never",allQuestionnaireData$response[[i]][2]) && length(allQuestionnaireData$response[[i]]) == 26){
    
    participantScore <- 0
    
    #1st order factors
    dietingScale <- 0 
    bulimiaScale <- 0
    oralControlScale <- 0
    
    #2nd order factors
    eatScore <- 0
    
    qIndex <- -1
    
      #-- Scoring eat-Test: Q1:25 3,2,1,0,0 Q26:0,0,0,1,2,3   --> Score of 20 or higher seeking of mental health professional adviced
    for(j in allQuestionnaireData$response[[i]]){
      
      qIndex <- qIndex + 1
      
      #normal scoring Items 1-25
      if(qIndex %in% c(0:24)){
        if(grepl("Always",j)){participantScore <- participantScore + 3}
        if(grepl("Usually",j)){participantScore <- participantScore + 2}
        if(grepl("Often",j)){participantScore <- participantScore + 1}
        if(grepl("Sometimes",j)){participantScore <- participantScore + 0}
        if(grepl("Rarely",j)){participantScore <- participantScore + 0}
        if(grepl("Never",j)){participantScore <- participantScore + 0}
        
        #1st order normal
        if(qIndex %in% c(0,5,6,9,10,11,13,15,16,21,22,23)){  dietingScale <- dietingScale + participantScore}
        if(qIndex %in% c(2,3,8,17,20,24)){ bulimiaScale <- bulimiaScale + participantScore}
        if(qIndex %in% c(1,4,7,12,14,18,19)){ oralControlScale <- oralControlScale + participantScore}
        
        participantScore <- 0
      }
      
      #reverse scoring Items 26
      if(qIndex %in% c(25)){
        if(grepl("Always",j)){participantScore <- participantScore + 0}
        if(grepl("Usually",j)){participantScore <- participantScore + 0}
        if(grepl("Often",j)){participantScore <- participantScore + 0}
        if(grepl("Sometimes",j)){participantScore <- participantScore + 1}
        if(grepl("Rarely",j)){participantScore <- participantScore + 2}
        if(grepl("Never",j)){participantScore <- participantScore + 3}
        
        #1st order reversed
        if(qIndex %in% c(25)){  dietingScale <- dietingScale + participantScore}
     
        participantScore <- 0
      }
      
      #calculation 2n order total score (sum 1nd order factors)
      eatScore <- dietingScale + bulimiaScale + oralControlScale
      
      questionnairesEvaluation$uniqueUserID[nrOfParticipant] <- allQuestionnaireData$uniqueUserID[[i]]
      questionnairesEvaluation$eat[nrOfParticipant] <- eatScore
      
        
    }
    
  }
  
  #searching for STAI Y1 (State)- Test in questionnaire battery for one participant
  if(grepl("Not at all|Somewhat|Moderately so|Very much so",allQuestionnaireData$response[[i]][2]) && length(allQuestionnaireData$response[[i]]) == 20){
  
    staiStateScore <- 0
    
    qIndex <- -1
    
    #-- Scoring StaiY1State-Test: Q1-20: 1,2,3,4  --> Anxiety scales can vary from a minimum of 20 to a maximum of 80
    for(j in allQuestionnaireData$response[[i]]){
      
      qIndex <- qIndex + 1
      
      #normal scoring Items 3,4,6,7,9,12,13,14,17,18   
      if(qIndex %in% c(2,3,5,6,8,11,12,13,16,17)){
        if(grepl("Not at all",j)){staiStateScore <- staiStateScore + 1}
        if(grepl("Somewhat",j)){staiStateScore <- staiStateScore + 2}
        if(grepl("Moderately so",j)){staiStateScore <- staiStateScore + 3}
        if(grepl("Very much so",j)){staiStateScore <- staiStateScore + 4}
        
      }
    
      #reverse scoring Items 1, 2, 5, 8, 10, 11, 15, 16, 19, 20
      if(qIndex %in% c(0,1,4,7,9,10,14,15,18,19)){
        if(grepl("Not at all",j)){staiStateScore <- staiStateScore + 4}
        if(grepl("Somewhat",j)){staiStateScore <- staiStateScore + 3}
        if(grepl("Moderately so",j)){staiStateScore <- staiStateScore + 2}
        if(grepl("Very much so",j)){staiStateScore <- staiStateScore + 1}
      }
      
      questionnairesEvaluation$uniqueUserID[nrOfParticipant] <- allQuestionnaireData$uniqueUserID[[i]]
      questionnairesEvaluation$anxiety1State[nrOfParticipant] <- staiStateScore
      }
  }
  
  #searching for STAI Y2 (Trait)- Test in questionnaire battery for one participant
  if(grepl("Almost never|Sometimes|Often|Almost always",allQuestionnaireData$response[[i]][2]) && length(allQuestionnaireData$response[[i]]) == 20){
    
    staiStraitScore <- 0
    
    qIndex <- -1
    
    #-- Scoring StaiY2Trait-Test: Q1-20: 1,2,3,4  --> Anxiety scales can vary from a minimum of 20 to a maximum of 80
    for(j in allQuestionnaireData$response[[i]]){
      
      qIndex <- qIndex + 1
      
      #normal scoring Items 2,4,5,8,9,11,12,15,17,18,20
      if(qIndex %in% c(1,3,4,7,8,10,11,14,16,17,19)){
        if(grepl("Almost never",j)){staiStraitScore <- staiStraitScore + 1}
        if(grepl("Sometimes",j)){staiStraitScore <- staiStraitScore + 2}
        if(grepl("Often",j)){staiStraitScore <- staiStraitScore + 3}
        if(grepl("Almost always",j)){staiStraitScore <- staiStraitScore + 4}
        
      }
      
      #reverse scoring Items 1,3,6,7,10,13,14,16,19
      if(qIndex %in% c(0,2,5,6,9,12,13,15,18)){
        if(grepl("Almost never",j)){staiStraitScore <- staiStraitScore + 4}
        if(grepl("Sometimes",j)){staiStraitScore <- staiStraitScore + 3}
        if(grepl("Often",j)){staiStraitScore <- staiStraitScore + 2}
        if(grepl("Almost always",j)){staiStraitScore <- staiStraitScore + 1}
      }
      
      questionnairesEvaluation$uniqueUserID[nrOfParticipant] <- allQuestionnaireData$uniqueUserID[[i]]
      questionnairesEvaluation$anxiety2Trait[nrOfParticipant] <- staiStraitScore
    }
    
  }
  
  #searching for Darigness- SubTest in questionnaire battery for one participant
  if(grepl("Not at all|Just a little|Pretty much/pretty often|Very much/very often",allQuestionnaireData$response[[i]][2]) && length(allQuestionnaireData$response[[i]]) == 5){
    
    darignessScore <- 0
    
    qIndex <- -1
    
    #-- Scoring darigness- Subtest: Q1-5: 1,2,3,4  --> 2nd order factor of CAD-Test - The higher the score the more daring
    for(j in allQuestionnaireData$response[[i]]){
      
      qIndex <- qIndex + 1
      
    #normal 2nd factor scoring Items 1-5   
    if(qIndex %in% c(0:4)){
      if(grepl("Not at all",j)){darignessScore <- darignessScore + 1}
      if(grepl("Just a little",j)){darignessScore <- darignessScore + 2}
      if(grepl("Pretty much/pretty often",j)){darignessScore <- darignessScore + 3}
      if(grepl("Very much/very often",j)){darignessScore <- darignessScore + 4}

    }
      questionnairesEvaluation$uniqueUserID[nrOfParticipant] <- allQuestionnaireData$uniqueUserID[[i]]
      questionnairesEvaluation$daringnessCADS[nrOfParticipant] <- darignessScore
      
    }
  
  }
 
  #searching for Taylor Manifest Anxiety Scale (TMAS)- Test in questionnaire battery for one participant
  if(grepl("True|False",allQuestionnaireData$response[[i]][2])){
    
    tmasScore <- 0
    
    qIndex <- -1
    
    #-- Scoring Tmas- Subtest: +1 for each answer indicating anxiety (see below for key)
    for(j in allQuestionnaireData$response[[i]]){
      
      qIndex <- qIndex + 1
    
    # Items indicating "anxiety" through the answer "True" : 2,5:8,10,11,13,14,16,17,19,21:28,30,31,33:37,39:49
    if(qIndex %in% c(1,4:7,9,10,12,13,15,16,18,20:27,29,30,32:35,37,39:49)){
      if(grepl("True",j)){tmasScore <- tmasScore + 1}
    }
    
    # Items indicating "anxiety" through the answer "False" : 1,3,4,9,12,15,18,20,29,32,38,50
    if(qIndex %in% c(0,2,3,8,11,14,17,19,28,31,38,50)){
      if(grepl("False",j)){tmasScore <- tmasScore + 1}
    }
      
      questionnairesEvaluation$uniqueUserID[nrOfParticipant] <- allQuestionnaireData$uniqueUserID[[i]]
      questionnairesEvaluation$anxietyTMAS[nrOfParticipant] <- tmasScore
      }
    
    }
  
  }

  return(questionnairesEvaluation)

}
questionnairesEvaluation <- evaluateQuestionnaires(mainTable)
show(questionnairesEvaluation)
```